function RevenueDoctorInvoiceTreat({DateFrom:i,DateTo:r,BranchID:n,MyLoad:e,CurrentMaster:t=0,MAXDATE:f=31,LIMITLOAD:u=7e4,fnSetting_Before:v,fnSetting_Complete:y,fnMaster_Before:c,fnMaster_Complete:l,fnMaster_CountComplete:a,fnDetail_Before:o,fnDetail_Complete:s,fnDetail_CountComplete:h,ver:p="0"}){RevenueDoctorInvoiceTreat.prototype.settings=this;this.DateFrom=i;this.DateTo=r;this.BranchID=n;this.MyLoad=e;this.CurrentMaster=0;this.MAXDATE=f;this.LIMITLOAD=u;this.XhrRevenueLoad=null;this.IsDocDevide=0;this.IsDocGreater=0;this.CostLabo=0;this.IsDocTreatDevide=0;this.IsDocTreatExCost=0;this.IsAssDevide=0;this.IsAssGreater=0;this.IsAssTreatDevide=0;this.IsTeleFirst=0;this.IsTeleExProduct=0;this.IsConDevide=0;this.IsCSKHExFirst=0;this.IsSuppDevide=0;this.DataRevMaster=[];this.DataRevDetail=[];this.DataRevAll=[];this.fnSetting_Before=v;this.fnSetting_Complete=y;this.fnMaster_Before=c;this.fnMaster_Complete=l;this.fnMaster_CountComplete=a;this.fnDetail_Before=o;this.fnDetail_Complete=s;this.fnDetail_CountComplete=h;this.Ver=p??Math.floor(Math.random()*1e3);this.Init=function(){let n=RevenueDoctorInvoiceTreat.prototype.settings;n.LoadData_Prepare_Report()};this.LoadData_Prepare_Report=function(){try{let n=RevenueDoctorInvoiceTreat.prototype.settings;AjaxJWT(url="/api/Commission/RevenueSettings?ver="+n.Ver,data={},async=!0,success=function(t){let i=[];if(t!=""&&t!="null"){i=JSON.parse(t);let r=i[0];n.IsDocDevide=Number(r.Doc_Devide);n.IsDocGreater=Number(r.Doc_Greater);n.CostLabo=Number(r.Doc_ExCost)>0?1:0;n.IsDocTreatDevide=Number(r.Docnomoney_Devide);n.IsDocTreatExCost=Number(r.DocTreat_ExCost)>0?1:0;n.IsAssDevide=Number(r.KTVPTM_Devide);n.IsAssGreater=Number(r.KTVPTM_Greater);n.IsTeleFirst=Number(r.TeleSale_First);n.IsTeleExProduct=Number(r.TeleSale_ExProduct);n.IsConDevide=Number(r.Consult_Devide);n.IsCSKHExFirst=Number(r.Cskh_Exfirst);n.IsSuppDevide=Number(r.Support_Devide)}typeof n.fnSetting_Complete=="function"&&n.fnSetting_Complete();n.LoadData_Report()},before=function(){typeof n.fnSetting_Before=="function"&&n.fnSetting_Before()})}catch(n){}};this.LoadData_Report=function(){let n=RevenueDoctorInvoiceTreat.prototype.settings,{BranchID:r,DateFrom:u,DateTo:f,MyLoad:i,MAXDATE:e}=n,o=u+" to "+f,t={};return t.date=o,t.maxdate=e,t.branch=r,t.empid=i,AjaxJWT(url="/api/Commission/RevDoctorInvoiceTreat_LoadData",data=JSON.stringify(t),async=!0,success=function(t){let r=JSON.parse(t),u=r.Table,f=r.Table1,e=u.concat(f);n.RevenueAll_Count(e);Number(i)!=0?typeof n.RevenueDetail_Load=="function"&&n.RevenueDetail_Load(i):(n.DataRevMaster=n.RevenueMaster_Count(n.DataRevAll),typeof n.fnMaster_CountComplete=="function"&&n.fnMaster_CountComplete(n.DataRevMaster),typeof n.fnMaster_Complete=="function"&&n.fnMaster_Complete())},before=function(){typeof n.fnMaster_Before=="function"&&n.fnMaster_Before()}),!1};this.RevenueAll_Count=function(n){new Promise(t=>{let r=RevenueDoctorInvoiceTreat.prototype.settings;r.DataRevAll=[];let u=0,i=0;if(n&&n.length>0)for(let t=0;t<n.length;t++)i=n[t].Amount!=0?n[t].TotalPaid/n[t].Price*n[t].Amount*n[t].Quantity:n[t].TotalPaid*n[t].Percent/100,u=i*n[t].RePercent/100,n[t].Manual_Revenue==1?(n[t].BS1!=0&&r.RevenueAll_Push(n[t],"BS1","RealAmount1",u,i),n[t].BS2!=0&&r.RevenueAll_Push(n[t],"BS2","RealAmount2",u,i),n[t].BS3!=0&&r.RevenueAll_Push(n[t],"BS3","RealAmount3",u,i)):n[t].BS1!=0&&r.RevenueAll_Push(n[t],"BS1","RealAmount1",u,i);t()})};this.RevenueAll_Push=function(n,t,i,r,u){try{let f=JSON.parse(JSON.stringify(n)),e=RevenueDoctorInvoiceTreat.prototype.settings;f.RealAmount=n.Manual_Revenue==0?r:n[i];f.Commission=n.Manual_Revenue==0?u:n[i];f.Emp=n[t];f.Empname=e.RevenueDetail_EmpName(n[t]);f.Empcode=e.RevenueDetail_EmpCode(n[t]);e.DataRevAll.push(f)}catch(f){}};this.RevenueMaster_Count=function(n){let t=[];if(n&&n.length!=0){let f=RevenueDoctorInvoiceTreat.prototype.settings,r=[],u=[],i={};i.emp=0;i.realamount=0;i.paymentperiod=0;i.totalPaid=0;for(let e=0;e<n.length;e++){let o=n[e];if(!r.includes(o.Emp)){r.push(o.Emp);let e=n.filter(n=>n.Emp==o.Emp);if(e&&e.length!=0){let n={};n.emp=0;n.realamount=0;n.paymentperiod=0;n.totalPaid=0;let r=[];for(let t=0;t<e.length;t++){let o=e[t],s=!r.includes(o.TabID);s&&r.push(o.TabID);n.emp=o.Emp;n.stt=t+1;n.empName=f.RevenueDetail_EmpName(o.Emp);n.realamount+=o.RealAmount;n.paymentperiod+=s?o.PaymentPeriod:0;n.totalPaid+=s?o.TotalPaid:0;let h=!u.includes(o.TabID);h&&(u.push(o.TabID),i.paymentperiod+=o.PaymentPeriod,i.totalPaid+=o.TotalPaid);i.realamount+=o.RealAmount}n?.ID!=0&&t.push(n)}}}t.unshift(i)}return t};this.RevenueDetail_Load=function(n){let t=RevenueDoctorInvoiceTreat.prototype.settings;return typeof t.fnDetail_Before=="function"&&t.fnDetail_Before(t.DataRevDetail),t.DataRevDetail=n==0?t.DataRevAll:t.DataRevAll.filter(t=>t.Emp==n),typeof t.fnDetail_Complete=="function"&&t.fnDetail_Complete(t.DataRevDetail),typeof t.fnDetail_CountComplete=="function"&&t.fnDetail_CountComplete(t.DataRevDetail),!1};this.ExportMaster=async function(n){let t=RevenueDoctorInvoiceTreat.prototype.settings,i={stt:"STT",empName:Outlang.Bac_si,realamount:Outlang.Hoa_hong},r=n!=""?n:Outlang.Doanh_thu_tong_ky_thuat_vien;await exportJsonToExcel(r,t.DataRevMaster,i)};this.ExportDetail=async function(n,t,i){let e=RevenueDoctorInvoiceTreat.prototype.settings,r=t==0,u=$("#"+i||""),f={CustCode:Outlang.Ma_khach_hang,CustName:Outlang.Khach_hang,SourceID:{isShow:r||u.find(`.shtoogle[data-name='Source']`).is(":checked"),data:[Outlang.Sys_nguon_khach_hang,n=>Fun_GetName_ByID(RP_DataCustomerSource,n)]},DocCode:{isShow:r||u.find(`.shtoogle[data-name='Source']`).is(":checked"),data:Outlang.Ma_ho_so},CustPhone:{dataNamePer:"CustPhone",isShow:r||u.find(`.shtoogle[data-name='CustPhone']`).is(":checked"),data:Outlang.So_dien_thoai},CustCodeOld:{isShow:r||u.find(`.shtoogle[data-name='CustCodeOld']`).is(":checked"),data:Outlang.Ma_khach_hang_cu!=undefined?Outlang.Ma_khach_hang_cu:"Mã khách hàng cũ"},CustAge:{isShow:r||u.find(`.shtoogle[data-name='CustAge']`).is(":checked"),data:Outlang.Tuoi!=undefined?Outlang.Tuoi:"Tuổi"},CustGender:{isShow:r||u.find(`.shtoogle[data-name='CustGender']`).is(":checked"),data:[Outlang.Gioi_tinh,(n,{CustGender:t})=>t==60?Outlang.Sys_nam:Outlang.Sys_nu1]},CustAddress:{dataNamePer:"CustAddress",isShow:r||u.find(`.shtoogle[data-name='CustAddress']`).is(":checked"),data:[Outlang.Sys_dia_chi_khach_hang1]},CustCommuneID:{dataNamePer:"CustCommu",isShow:r||u.find(`.shtoogle[data-name='CustCommu']`).is(":checked"),data:[Outlang.Phuong_xa??"Phường xã",n=>Fun_GetName_ByID(RP_DataCommune,n)]},CustDistrictID:{dataNamePer:"CustDistrict",isShow:r||u.find(`.shtoogle[data-name='CustDistrict']`).is(":checked"),data:[Outlang.Quan_huyen??"Quận huyện",n=>Fun_GetName_ByID(RP_DataDistrict,n)]},CustCityID:{dataNamePer:"CustCity",isShow:r||u.find(`.shtoogle[data-name='CustCity']`).is(":checked"),data:[Outlang.Sys_thanh_pho??"Thành phố",n=>Fun_GetName_ByID(RP_DataCity,n)]},Service_Code:{isShow:r||u.find(`.shtoogle[data-name='ServiceCode']`).is(":checked"),data:Outlang.Ma_dich_vu!=undefined?Outlang.Ma_dich_vu:"Mã dịch vụ"},ServiceID:[Outlang.Dich_vu,n=>e.RevenueDetail_ServiceName(n)],ServiceType:Outlang.Loai_dich_vu!=undefined?Outlang.Loai_dich_vu:"Loại dịch vụ",SaleCode:{isShow:r||u.find(`.shtoogle[data-name='SaleCode']`).is(":checked"),data:Outlang.Ma_len_don},Qty:{isShow:r||u.find(`.shtoogle[data-name='Quantity']`).is(":checked"),data:Outlang.Sl??"Sl"},Price_Root:{isShow:r||u.find(`.shtoogle[data-name='Price_Root']`).is(":checked"),data:Outlang.Gia_ban_dau??"Giá ban đầu"},Price:{isShow:r||u.find(`.shtoogle[data-name='Price']`).is(":checked"),data:Outlang.Thanh_tien},Paid:{data:Outlang.Sys_thanh_toan},Detail:[Outlang.Chi_tiet_dich_vu_dieu_tri,(n,{TimeTreatIndex:u,TimeTreat:r,TeethType:i,TeethChoosing:t})=>Number(sys_dencos_Main)==1?`${t!=""?Fun_GetTeeth_ByToken(DataTeeth,t,i):""} `:Outlang.Lan_dieu_tri+": "+u+" | "+r],NewPer:[`% ${Outlang.Dieu_tri}`,(n,{NewPer:t,TimeTreatIndex:r,TimeTreat:i})=>Number(sys_dencos_Main)==1?t:Number(i)!=0?(Number(r)/Number(i)*100).toFixed(2):0],PercentOfService:[`% ${Outlang.Hoan_thanh??"Hoàn thành"}`,(n,{TimeTreatIndex:f,TimeTreat:u,TreatDetail:e,PercentOfService:t,TeethChoosing:r,TreatPercentDetail:o,Quantity:i})=>this.RevenueDetail_TreatmentOrPercentService(f,u,e,t,r,o,i)],Empname:Outlang.Bac_si,Empcode:{isShow:r||u.find(`.shtoogle[data-name='EmpCode']`).is(":checked"),data:Outlang.Ma_nhan_vien??"Mã nhân viên"},Commission:Outlang.Hoa_hong,RePercent:"%"+(Outlang.Thuc_lanh??"Thực lãnh"),RealAmount:Outlang.Thuc_lanh??"Thực lãnh",NumDateDevide:{isShow:r||u.find(`.shtoogle[data-name='datedevide']`).is(":checked"),data:[Outlang.Ngay_chia_hoa_hong??"Ngày chia",n=>SysDate().FUTCFULLNUM(n).DateText()]},PaymentPeriod:Outlang.Dt_trong_ky??"Dt trong kỳ",PaymentService:Outlang.Doanh_thu,TabNumCreated:{isShow:r||u.find(`.shtoogle[data-name='datecreated']`).is(":checked"),data:[Outlang.Ngay_thanh_toan,n=>SysDate().FUTCFULLNUM(n).DateText()]},NumDatePay:{isShow:r||u.find(`.shtoogle[data-name='datepay']`).is(":checked"),data:[Outlang.Ngay_len_dich_vu??"Ngày lên dịch vụ",n=>SysDate().FUTCFULLNUM(n).DateText()]},Date:{isShow:r||u.find(`.shtoogle[data-name='Date']`).is(":checked"),data:[Outlang.Ngay_dieu_tri,n=>SysDate().FUTC(n).DateText()]},BranchName:{isShow:r||u.find(`.shtoogle[data-name='Branch']`).is(":checked"),data:Outlang.Ten_chi_nhanh},IsNew:{isShow:r||u.find(`.shtoogle[data-name='CusNew']`).is(":checked"),data:[Outlang.Khach_hang_moi??"Khách hàng mới",n=>n==1?"new":""]},Note:Outlang.Ghi_chu_hoa_hong==undefined?"Ghi chú hoa hồng":Outlang.Ghi_chu_hoa_hong,InsurAmount:{isShow:r||u.find(`.shtoogle[data-name='amount_insurance']`).is(":checked"),data:[Outlang.Bao_hiem,n=>n]},TreatContent:{isShow:r||u.find(`.shtoogle[data-name='TreatContent']`).is(":checked"),data:Outlang.Noi_dung_dieu_tri!=undefined?Outlang.Noi_dung_dieu_tri:"Nội dung điều trị"},Manual_Revenue:{isShow:r||u.find(`.shtoogle[data-name='Craftsmanship']`).is(":checked"),data:Outlang.Thu_cong}};f=Checking_TabControl_System_RebuildHeader(f,tableBodyId="dtContentReportBody",PermissionTable_TabControl);let o=n!=""?n:Outlang.Doanh_thu;await exportJsonToExcel(o,e.DataRevDetail,f)};this.RevenueDetail_ServiceName=function(n){try{return RP_DataService[n].Name}catch(t){return""}};this.RevenueDetail_TreatmentOrPercentService=function(n,t,i,r,u,f,e){try{return sys_dencos_Main==0?t!=0?100*n/t:0:i==0?r:u!=""?e!=0?f/e:0:f}catch(o){return 0}};this.RevenueDetail_EmpName=function(n){try{return RP_DataEmployee[n]!=undefined?RP_DataEmployee[n].Name:""}catch(t){return""}};this.RevenueDetail_EmpCode=function(n){try{return RP_DataEmployee[n]!=undefined?RP_DataEmployee[n].Code:""}catch(t){return""}}}